# 文件缓存与上传用户强绑定测试说明

## 测试脚本

`test_file_cache_user_binding.py` - 测试文件缓存与上传用户强绑定功能

## 测试场景

### 测试用例1: 相同文件哈希 + 相同用户 = 可以复用缓存
- **场景**: 用户1上传文件后，再次上传相同文件
- **预期**: 应该检测到可复用的缓存，允许复用文件记录和缓存
- **验证点**:
  - 文件记录存在且用户匹配
  - 文件信息缓存存在
  - 文件块缓存存在
  - 密钥缓存存在

### 测试用例2: 相同文件哈希 + 不同用户 = 不能复用缓存（用户隔离）
- **场景**: 用户1上传文件后，用户2上传相同哈希的文件
- **预期**: 应该创建新的文件记录，不能复用用户1的缓存
- **验证点**:
  - 用户2的文件记录不存在（因为还没上传）
  - 用户2无法访问用户1的缓存
  - 用户2创建新文件记录时，不复用用户1的记录

### 测试用例3: 不同文件哈希 + 相同用户 = 不能复用缓存
- **场景**: 用户1上传文件1后，上传文件2（不同哈希）
- **预期**: 应该创建新的文件记录，不能复用文件1的缓存
- **验证点**:
  - 文件2不存在（因为还没创建）
  - 创建文件2时，不复用文件1的记录

### 测试用例4: 未过期文件检测功能
- **场景**: 用户1上传文件并创建未过期的取件码
- **预期**: 应该能正确检测到未过期的文件和缓存
- **验证点**:
  - 能找到未过期的取件码
  - 文件信息缓存存在且未过期
  - 文件块缓存存在且未过期

### 测试用例5: 已过期文件允许创建新取件码
- **场景**: 用户1上传文件并创建已过期的取件码
- **预期**: 即使文件块缓存存在，但因为所有取件码都已过期，应该允许创建新码
- **验证点**:
  - 所有取件码都已过期
  - 即使文件块缓存存在，也应该允许创建新码

## 使用方法

### Windows (推荐)

**方法1: 使用批处理脚本（最简单）**
```cmd
scripts\test\file_cache_user_binding\run_test.bat
```

**方法2: 手动运行**
```cmd
# 激活虚拟环境
venv\Scripts\activate

# 运行测试
python scripts\test\file_cache_user_binding\test_file_cache_user_binding.py
```

### Linux/Mac

```bash
# 确保在项目根目录
cd /path/to/quick-share

# 激活虚拟环境
source venv/bin/activate

# 运行测试
python scripts/test/file_cache_user_binding/test_file_cache_user_binding.py
```

## 测试数据

测试脚本会：
1. **创建测试用户**
   - `test_user_cache_1` (用户1)
   - `test_user_cache_2` (用户2)

2. **创建测试文件**
   - 文件1: 哈希 = "a" * 64, 用户1
   - 文件2: 哈希 = "a" * 64, 用户2 (相同哈希，不同用户)
   - 文件3: 哈希 = "b" * 64, 用户1 (不同哈希，相同用户)
   - 文件4: 哈希 = "c" * 64, 用户1 (未过期)
   - 文件5: 哈希 = "d" * 64, 用户1 (已过期)

3. **设置测试缓存**
   - 为每个文件设置文件块缓存、文件信息缓存、密钥缓存
   - 使用正确的用户ID和过期时间

4. **验证用户隔离**
   - 确保不同用户之间不能互相访问缓存
   - 确保只有文件哈希相同且上传用户也相同时，才认为是同一个文件

## 预期结果

所有测试用例应该通过：
- ✓ 测试用例1: 相同文件哈希 + 相同用户 = 可以复用缓存
- ✓ 测试用例2: 相同文件哈希 + 不同用户 = 不能复用缓存（用户隔离）
- ✓ 测试用例3: 不同文件哈希 + 相同用户 = 不能复用缓存
- ✓ 测试用例4: 未过期文件检测功能正常工作
- ✓ 测试用例5: 已过期文件允许创建新取件码

## 注意事项

1. **数据库连接**: 测试需要连接到数据库，请确保数据库服务正在运行
2. **Redis连接**: 测试需要连接到Redis，请确保Redis服务正在运行
3. **测试数据清理**: 测试脚本会自动清理测试数据，但如果测试中断，可能需要手动清理
4. **虚拟环境**: 建议在虚拟环境中运行测试，避免影响系统环境

## 手动测试步骤

如果需要手动验证功能，可以：

1. **创建两个测试用户**
   - 用户1: `test_user_cache_1`
   - 用户2: `test_user_cache_2`

2. **用户1上传文件**
   - 上传文件 `test_file_1.txt` (哈希: "a" * 64)
   - 生成取件码并上传文件块
   - 验证缓存已创建

3. **用户1再次上传相同文件**
   - 应该检测到可复用的缓存
   - 应该提示是否复用

4. **用户2上传相同文件**
   - 上传文件 `test_file_1.txt` (哈希: "a" * 64)
   - 应该创建新的文件记录
   - 不应该复用用户1的缓存

5. **验证用户隔离**
   - 检查用户1的缓存键: 应该只包含用户1的数据
   - 检查用户2的缓存键: 应该只包含用户2的数据
   - 确保用户之间不能互相访问缓存

