# 实现登录功能和权限控制

## 1. 项目现状分析

* 前端已实现登录/注册UI和逻辑

* 后端缺少用户模型和认证路由

* 现有接口未进行权限控制

* 需要实现两种模式：登录模式（可分发和接受）和游客模式（只能接受）

## 2. 实现步骤

### 2.1 创建用户模型

* 在 `app/models/` 目录下创建 `user.py` 文件

* 定义 User 模型，包含 id, username, password\_hash, created\_at 等字段

* 更新 `app/models/__init__.py` 导出新模型

### 2.2 创建认证路由

* 在 `app/routes/` 目录下创建 `auth.py` 文件

* 实现注册、登录、验证token等接口

* 使用 JWT 进行身份验证

### 2.3 更新现有接口

* 修改 `app/routes/codes.py` 中的接口，加入权限控制

* 修改 `app/routes/relay.py` 中的接口，加入权限控制

* 实现两种模式的权限检查：

  * 登录用户：可调用所有接口

  * 游客：只能调用接收相关接口

### 2.4 更新数据库迁移

* 运行数据库迁移命令，创建用户表

### 2.5 测试和验证

* 测试登录/注册功能

* 测试两种模式下的接口访问权限

* 确保现有功能不受影响

## 3. 技术实现细节

### 3.1 用户模型设计

```python
class User(Base):
    id: int = Column(Integer, primary_key=True, index=True)
    username: str = Column(String(50), unique=True, index=True, nullable=False)
    password_hash: str = Column(String(128), nullable=False)
    created_at: datetime = Column(DateTime, default=datetime.utcnow)
```

### 3.2 认证路由设计

* POST /api/v1/auth/register：用户注册

* POST /api/v1/auth/login：用户登录

* GET /api/v1/auth/verify：验证token

### 3.3 权限控制实现

* 使用 FastAPI 的 Depends 机制实现依赖注入

* 创建 get\_current\_user 依赖函数，用于获取当前登录用户

* 在需要权限控制的接口中使用该依赖

## 4. 预期效果

* 用户可以注册和登录

* 登录用户可以生成取件码（分发）和使用取件码（接受）

* 游客只能使用取件码（接受），不能生成取件码

* 所有API访问都经过权限验证

* 现有功能保持不变

## 5. 注意事项

* 确保密码安全存储（使用哈希算法）

* 实现合理的错误处理

* 保持接口的向后兼容性

* 遵循现有代码的风格和架构

