# 实现登录功能和权限控制

## 1. 已完成的实现

### 1.1 创建用户模型
- ✅ 在 `app/models/` 目录下创建了 `user.py` 文件
- ✅ 定义了 User 模型，包含 id, username, password_hash, created_at 等字段
- ✅ 更新了 `app/models/__init__.py` 导出新模型

### 1.2 创建认证路由
- ✅ 在 `app/routes/` 目录下创建了 `auth.py` 文件
- ✅ 实现了注册、登录、验证token等接口
- ✅ 使用 JWT 进行身份验证

### 1.3 更新现有接口
- ✅ 修改了 `app/routes/codes.py` 中的 `create_code` 接口，加入权限控制
- ✅ 修改了 `app/routes/relay.py` 中的 `upload_chunk`、`upload_complete`、`store_encrypted_key`、`check_chunks` 接口，加入权限控制
- ✅ 实现了两种模式的权限检查：
  - 登录用户：可调用所有接口
  - 游客：只能调用接收相关接口

### 1.4 更新数据库迁移
- ✅ 运行了数据库迁移命令，创建了用户表

## 2. 技术实现细节

### 2.1 用户模型设计
```python
class User(Base):
    id: int = Column(Integer, primary_key=True, index=True)
    username: str = Column(String(50), unique=True, index=True, nullable=False)
    password_hash: str = Column(String(128), nullable=False)
    created_at: datetime = Column(DateTime, default=datetime.utcnow)
```

### 2.2 认证路由设计
- POST /api/v1/auth/register：用户注册
- POST /api/v1/auth/login：用户登录
- GET /api/v1/auth/verify：验证token

### 2.3 权限控制实现
- 使用 FastAPI 的 Depends 机制实现依赖注入
- 创建了 `get_current_user` 依赖函数，用于获取当前登录用户
- 在需要权限控制的接口中使用该依赖
- 只有登录用户才能调用分发文件相关的接口
- 游客只能调用接收文件相关的接口

## 3. 后续步骤

### 3.1 安装缺失的依赖
```bash
pip install python-jose
```

### 3.2 测试和验证
- 测试登录/注册功能
- 测试两种模式下的接口访问权限
- 确保现有功能不受影响

### 3.3 部署
- 配置生产环境的 JWT 密钥
- 优化 JWT 过期时间
- 考虑添加刷新令牌功能

## 4. 预期效果

- 用户可以注册和登录
- 登录用户可以生成取件码（分发）和使用取件码（接受）
- 游客只能使用取件码（接受），不能生成取件码
- 所有API访问都经过权限验证
- 现有功能保持不变

## 5. 注意事项

- 密码使用 SHA-256 进行哈希存储
- 使用 JWT 进行身份验证，安全性较高
- 实现了合理的错误处理
- 保持了接口的向后兼容性
- 遵循了现有代码的风格和架构