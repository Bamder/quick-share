openapi: 3.0.0
info:
  title: 文件闪传系统 API
  description: 一个基于FastAPI的文件闪传系统，支持端到端加密、取件码分享、大文件分片传输等功能
  version: 1.0.0
  contact:
    name: 开发团队
    email: contact@example.com

servers:
  - url: http://localhost:8000
    description: 本地开发服务器
  - url: https://api.example.com
    description: 生产服务器

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: 使用Bearer令牌进行认证，令牌由登录接口返回

security:
  - bearerAuth: []

paths:
  # 系统健康检查（无需认证）
  /health:
    get:
      tags:
        - 系统状态
      summary: 服务健康检查
      description: 检查服务是否正常运行，包括数据库连接状态
      operationId: checkHealth
      responses:
        '200':
          description: 服务运行正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 操作成功
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        example: healthy
                      database:
                        type: string
                        example: connected
                      timestamp:
                        type: string
                        format: date-time
                        example: 2024-01-01T00:00:00Z
                      service:
                        type: string
                        example: 文件闪传系统API
                      version:
                        type: string
                        example: 2.0.0
                        
  # 认证管理
  /api/v1/auth/register:
    post:
      tags:
        - 认证管理
      summary: 用户注册
      description: 创建新用户并返回访问令牌
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: 注册成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: 注册失败，用户名已存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/login:
    post:
      tags:
        - 认证管理
      summary: 用户登录
      description: 验证用户凭据并返回访问令牌
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: 登录成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: 登录失败，用户名或密码错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/verify:
    get:
      tags:
        - 认证管理
      summary: 验证访问令牌
      description: 验证访问令牌的有效性并返回用户信息
      operationId: verifyToken
      responses:
        '200':
          description: 令牌有效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyTokenResponse'
        '400':
          description: 令牌无效或已过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 取件码管理
  /api/v1/codes:
    post:
      tags:
        - 取件码管理
      summary: 创建文件元数据对象和取件码
      description: 生成唯一取件码，用于文件传输
      operationId: createCode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCodeRequest'
      responses:
        '201':
          description: 取件码创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateCodeResponse'
        '400':
          description: 创建失败，文件已存在或参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/codes/{code}/status:
    get:
      tags:
        - 取件码管理
      summary: 查询取件码状态
      description: 获取取件码的详细信息和使用状态
      operationId: getCodeStatus
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      responses:
        '200':
          description: 取件码状态查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickupCodeStatusResponse'
        '404':
          description: 取件码不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/codes/{code}/file-info:
    get:
      tags:
        - 取件码管理
      summary: 获取文件详细信息
      description: 根据取件码获取关联文件的详细信息
      operationId: getFileInfoByCode
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      responses:
        '200':
          description: 文件信息查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileInfoResponse'
        '404':
          description: 取件码不存在或文件已被删除
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/codes/{code}/usage:
    post:
      tags:
        - 取件码管理
      summary: 增加使用次数
      description: 增加取件码的使用次数，并检查是否达到使用上限
      operationId: incrementUsage
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      responses:
        '200':
          description: 使用次数更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsageUpdateResponse'
        '400':
          description: 已达到使用上限
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 取件码不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/codes/files/{file_id}/invalidate:
    post:
      tags:
        - 取件码管理
      summary: 作废文件记录
      description: 将文件关联的所有取件码标记为过期，并清理所有相关缓存
      operationId: invalidateFile
      parameters:
        - name: file_id
          in: path
          required: true
          description: 文件ID
          schema:
            type: integer
      responses:
        '200':
          description: 文件记录已作废
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 文件记录已作废
                  data:
                    type: object
        '404':
          description: 文件不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 服务器中转 - 上传相关
  /api/v1/relay/codes/{code}/upload-chunk:
    post:
      tags:
        - 服务器中转
      summary: 上传加密的文件块（流式传输）
      description: 上传文件的加密块，支持断点续传
      operationId: uploadChunk
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
        - name: chunk_index
          in: query
          description: 文件块索引
          schema:
            type: integer
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                chunk_index:
                  type: integer
                  description: 文件块索引（也可作为查询参数传递）
                chunk_data:
                  type: string
                  format: binary
                  description: 文件块数据
      responses:
        '200':
          description: 文件块上传成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 文件块上传成功
                  data:
                    type: object
        '400':
          description: 上传失败，参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/relay/codes/{code}/upload-complete:
    post:
      tags:
        - 服务器中转
      summary: 通知服务器上传完成
      description: 通知服务器文件上传完成，存储文件元信息
      operationId: uploadComplete
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UploadCompleteRequest'
      responses:
        '200':
          description: 上传完成通知成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 上传完成
                  data:
                    type: object
        '400':
          description: 通知失败，参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/relay/codes/{code}/store-encrypted-key:
    post:
      tags:
        - 服务器中转
      summary: 存储加密后的文件加密密钥
      description: 存储用取件码密钥码加密后的文件加密密钥
      operationId: storeEncryptedKey
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                encryptedKey:
                  type: string
                  description: 加密后的文件加密密钥（Base64编码）
      responses:
        '200':
          description: 加密密钥已存储
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 加密密钥已存储
                  data:
                    type: object
                    properties:
                      code:
                        type: string
                      originalLookupCode:
                        type: string
        '400':
          description: 存储失败，参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 服务器中转 - 下载相关
  /api/v1/relay/codes/{code}/encrypted-key:
    get:
      tags:
        - 服务器中转
      summary: 获取加密后的文件加密密钥
      description: 获取用取件码密钥码加密后的文件加密密钥
      operationId: getEncryptedKey
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      responses:
        '200':
          description: 加密密钥获取成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 加密密钥获取成功
                  data:
                    type: object
                    properties:
                      encryptedKey:
                        type: string
                        description: 加密后的文件加密密钥
                      sessionId:
                        type: string
                        description: 下载会话ID
        '404':
          description: 加密密钥不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/relay/codes/{code}/file-info:
    get:
      tags:
        - 服务器中转
      summary: 获取文件信息
      description: 获取文件的元信息，包括文件名、大小、类型等
      operationId: getFileInfoForDownload
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      responses:
        '200':
          description: 文件信息获取成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 文件信息获取成功
                  data:
                    type: object
                    properties:
                      fileName:
                        type: string
                      fileSize:
                        type: integer
                      mimeType:
                        type: string
                      totalChunks:
                        type: integer
                      uploadedAt:
                        type: string
                        format: date-time
        '404':
          description: 文件信息不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/relay/codes/{code}/download-chunk/{chunk_index}:
    get:
      tags:
        - 服务器中转
      summary: 下载加密的文件块（流式传输）
      description: 下载文件的加密块，支持断点续传
      operationId: downloadChunk
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
        - name: chunk_index
          in: path
          required: true
          description: 文件块索引
          schema:
            type: integer
        - name: session_id
          in: query
          description: 下载会话ID
          schema:
            type: string
      responses:
        '200':
          description: 文件块下载成功
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '404':
          description: 文件块不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/relay/codes/{code}/download-chunks:
    post:
      tags:
        - 服务器中转
      summary: 批量下载文件块
      description: 批量下载多个文件块，优化下载性能
      operationId: downloadChunksBatch
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DownloadChunksRequest'
      responses:
        '200':
          description: 文件块批量下载成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 文件块批量下载成功
                  data:
                    type: object
                    properties:
                      chunks:
                        type: object
                        additionalProperties:
                          type: object
                          properties:
                            data:
                              type: string
                              format: binary
                            hash:
                              type: string
                      missing:
                        type: array
                        items:
                          type: integer
                      expired:
                        type: array
                        items:
                          type: integer
        '400':
          description: 下载失败，参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/relay/codes/{code}/download-complete:
    post:
      tags:
        - 服务器中转
      summary: 通知服务器下载完成
      description: 通知服务器下载完成，清理会话记录，增加使用次数
      operationId: downloadComplete
      parameters:
        - name: code
          in: path
          required: true
          description: 6位取件码
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DownloadCompleteRequest'
      responses:
        '200':
          description: 下载完成通知成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 下载完成
                  data:
                    type: object
        '400':
          description: 通知失败，参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 安全管理
  /api/v1/reports:
    post:
      tags:
        - 安全管理
      summary: 举报违规文件
      description: 举报违规文件，支持匿名举报
      operationId: reportFile
      security: []  # 举报接口无需认证
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReportRequest'
      responses:
        '201':
          description: 举报已受理
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 201
                  msg:
                    type: string
                    example: 举报已受理，感谢您的反馈
                  data:
                    type: object
                    properties:
                      reportId:
                        type: integer
                      reportedAt:
                        type: string
                        format: date-time
                      status:
                        type: string
        '400':
          description: 举报失败，参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/reports/{report_id}:
    get:
      tags:
        - 安全管理
      summary: 获取举报状态
      description: 查询举报的处理状态
      operationId: getReportStatus
      security: []  # 举报状态查询无需认证
      parameters:
        - name: report_id
          in: path
          required: true
          description: 举报ID
          schema:
            type: integer
      responses:
        '200':
          description: 举报状态查询成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  msg:
                    type: string
                    example: 操作成功
                  data:
                    type: object
                    properties:
                      reportId:
                        type: integer
                      code:
                        type: string
                      reason:
                        type: string
                      status:
                        type: string
                      reportedAt:
                        type: string
                        format: date-time
                      updatedAt:
                        type: string
                        format: date-time
        '404':
          description: 举报记录不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    # 通用响应模型
    ErrorResponse:
      type: object
      properties:
        code:
          type: integer
          example: 400
        msg:
          type: string
          example: 操作失败
        data:
          type: object
      required:
        - code
        - msg

    # 认证相关模型
    RegisterRequest:
      type: object
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
          description: 用户名
          example: user123
        password:
          type: string
          minLength: 6
          maxLength: 64
          description: 密码（前端已哈希，SHA-256，64字符）
          example: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
      required:
        - username
        - password

    LoginRequest:
      type: object
      properties:
        username:
          type: string
          description: 用户名
          example: user123
        password:
          type: string
          description: 密码
          example: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
      required:
        - username
        - password

    UserResponse:
      type: object
      properties:
        id:
          type: integer
          example: 1
        username:
          type: string
          example: user123
        created_at:
          type: string
          format: date-time
          example: 2024-01-01T00:00:00Z
      required:
        - id
        - username
        - created_at

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        token_type:
          type: string
          example: bearer
        user:
          $ref: '#/components/schemas/UserResponse'
      required:
        - access_token
        - token_type
        - user

    VerifyTokenResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/UserResponse'
      required:
        - user

    # 取件码相关模型
    CreateCodeRequest:
      type: object
      properties:
        originalName:
          type: string
          minLength: 1
          maxLength: 255
          description: 文件原始名称
          example: document.pdf
        size:
          type: integer
          description: 文件大小（字节）
          example: 1024
        mimeType:
          type: string
          maxLength: 100
          description: 文件MIME类型
          example: application/pdf
        hash:
          type: string
          maxLength: 64
          description: 明文文件SHA256哈希值（前端计算，用于后端派生去重指纹）
          example: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
        limitCount:
          type: integer
          minimum: 1
          maximum: 999
          default: 3
          description: 最大使用次数（999=无限）
          example: 3
        expireHours:
          type: number
          minimum: 0.1
          maximum: 168.0
          default: 24.0
          description: 过期时间（小时，支持小数，如0.5表示30分钟，默认24小时，最大7天）
          example: 24.0
        reuseFileCache:
          type: boolean
          default: false
          description: 是否复用现有的文件缓存
        identifierCode:
          type: string
          maxLength: 6
          description: 要复用的标识码
      required:
        - originalName
        - size

    CreateCodeResponse:
      type: object
      properties:
        code:
          type: string
          description: 完整的12位取件码
          example: ABC123DEF456
        fileId:
          type: integer
          example: 1
        fileName:
          type: string
          example: document.pdf
        fileSize:
          type: integer
          example: 1024
        mimeType:
          type: string
          example: application/pdf
        limitCount:
          type: integer
          example: 3
        expireAt:
          type: string
          format: date-time
          example: 2024-01-02T00:00:00Z
        createdAt:
          type: string
          format: date-time
          example: 2024-01-01T00:00:00Z
        identifierCode:
          type: string
          description: 标识码，供前端存储
          example: ABC123
      required:
        - code
        - fileId
        - fileName
        - fileSize
        - limitCount
        - expireAt
        - createdAt

    PickupCodeStatusResponse:
      type: object
      properties:
        code:
          type: string
          example: ABC123
        fileId:
          type: integer
          example: 1
        fileName:
          type: string
          example: document.pdf
        fileSize:
          type: integer
          example: 1024
        mimeType:
          type: string
          example: application/pdf
        status:
          type: string
          example: waiting
        usedCount:
          type: integer
          example: 0
        limitCount:
          type: integer
          example: 3
        expireAt:
          type: string
          format: date-time
          example: 2024-01-02T00:00:00Z
        createdAt:
          type: string
          format: date-time
          example: 2024-01-01T00:00:00Z
      required:
        - code
        - fileId
        - fileName
        - fileSize
        - mimeType
        - status
        - usedCount
        - limitCount
        - expireAt
        - createdAt

    FileInfoResponse:
      type: object
      properties:
        fileId:
          type: integer
          example: 1
        originalName:
          type: string
          example: document.pdf
        storedName:
          type: string
          example: 123e4567-e89b-12d3-a456-426614174000
        size:
          type: integer
          example: 1024
        hash:
          type: string
          nullable: true
          example: null
        mimeType:
          type: string
          nullable: true
          example: application/pdf
        createdAt:
          type: string
          format: date-time
          example: 2024-01-01T00:00:00Z
      required:
        - fileId
        - originalName
        - storedName
        - size
        - createdAt

    UsageUpdateResponse:
      type: object
      properties:
        code:
          type: string
          example: ABC123
        usedCount:
          type: integer
          example: 1
        limitCount:
          type: integer
          example: 3
        remaining:
          type: integer
          example: 2
        updatedAt:
          type: string
          format: date-time
          example: 2024-01-01T00:00:00Z
      required:
        - code
        - usedCount
        - limitCount
        - remaining
        - updatedAt

    # 服务器中转相关模型
    UploadCompleteRequest:
      type: object
      properties:
        totalChunks:
          type: integer
          description: 总块数
          example: 10
        fileSize:
          type: integer
          description: 文件大小（字节）
          example: 10240
        fileName:
          type: string
          description: 文件名
          example: document.pdf
        mimeType:
          type: string
          description: 文件MIME类型
          example: application/pdf
      required:
        - totalChunks
        - fileSize
        - fileName
        - mimeType

    DownloadChunksRequest:
      type: object
      properties:
        chunkIndices:
          type: array
          items:
            type: integer
          description: 要下载的块索引列表
          example: [0, 1, 2]
        sessionId:
          type: string
          description: 下载会话ID
          example: abc123def456
      required:
        - chunkIndices

    DownloadCompleteRequest:
      type: object
      properties:
        session_id:
          type: string
          description: 下载会话ID
          example: abc123def456

    # 举报相关模型
    UserInfo:
      type: object
      properties:
        userAgent:
          type: string
          description: 用户代理字符串
          example: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        ipAddress:
          type: string
          description: IP地址（可选，服务器会自动获取）
          example: 192.168.1.1
        platform:
          type: string
          description: 平台信息
          example: Windows
      required:
        - userAgent

    ReportRequest:
      type: object
      properties:
        code:
          type: string
          pattern: '^[A-Z0-9]{6}$'
          description: 取件码
          example: ABC123
        reason:
          type: string
          minLength: 1
          maxLength: 500
          description: 举报原因
          example: 该文件包含违规内容
        reporterInfo:
          $ref: '#/components/schemas/UserInfo'
      required:
        - code
        - reason
